<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Time Pokémon - Web</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Seu HTML permanece o mesmo -->

  <script>
    let team = [];

    async function convertToBase64(url) {
      const res = await fetch(url);
      const blob = await res.blob();
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }

    document.getElementById("cameraInput").addEventListener("change", async function (e) {
      const file = e.target.files[0];
      const img = document.getElementById("trainerPhoto");

      if (file) {
        const localURL = URL.createObjectURL(file);
        const base64 = await convertToBase64(localURL);
        img.src = base64;
      } else {
        img.src = "imagens/trainer-placeholder.png";
      }
    });

    async function buscarPokemon() {
      const name = document.getElementById("pokemonInput").value.trim();
      const errorText = document.getElementById("errorText");
      if (!name) return;

      try {
        const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${name.toLowerCase()}`);
        if (!res.ok) throw new Error();

        const data = await res.json();
        if (team.length >= 6) {
          errorText.textContent = "Time completo (6/6)";
          return;
        }

        const base64 = await convertToBase64(data.sprites.front_default);

        team.push({ name: data.name, image: base64 });
        document.getElementById("pokemonInput").value = "";
        errorText.textContent = "";
        renderTeam();
      } catch {
        errorText.textContent = "Pokémon não encontrado";
      }
    }

    function renderTeam() {
      document.getElementById("count").textContent = team.length;
      const col1 = document.getElementById("col1");
      const col2 = document.getElementById("col2");
      col1.innerHTML = "";
      col2.innerHTML = "";

      team.forEach((p, i) => {
        const card = `<div class='pokemon-card'>
            <img src='${p.image}' crossorigin="anonymous" />
            <span>${p.name.charAt(0).toUpperCase() + p.name.slice(1)}</span>
          </div>`;
        if (i < 3) col1.innerHTML += card;
        else col2.innerHTML += card;
      });
    }

    function resetTeam() {
      team = [];
      renderTeam();
      document.getElementById("errorText").textContent = "";
    }

    function salvarImagem() {
      const element = document.querySelector(".pokedex-frame");
      const rect = element.getBoundingClientRect();

      // Esconde elementos indesejados durante a captura
      document.querySelectorAll(".no-capture-item").forEach(el => {
        el.classList.add("no-capture");
      });

      html2canvas(element, {
        useCORS: true,
        allowTaint: true,
        backgroundColor: null,
        removeContainer: true,
        scale: 2,  // Fixo em 2 para evitar problemas com devicePixelRatio
        width: rect.width,
        height: rect.height,
        scrollX: 0,
        scrollY: -window.scrollY,
        logging: false  // Remove logs desnecessários
        // Removido: foreignObjectRendering: true (não necessário e causa problemas)
      }).then(canvas => {
        const link = document.createElement("a");
        link.download = "meu-time.png";
        link.href = canvas.toDataURL("image/png");
        link.click();

        // Remove a classe após a captura
        document.querySelectorAll(".no-capture-item").forEach(el => {
          el.classList.remove("no-capture");
        });
      }).catch(error => {
        console.error("Erro ao gerar PNG:", error);

        // Fallback para SVG
        if (typeof domtoimage !== 'undefined') {
          domtoimage.toSvg(element)
            .then(function (dataUrl) {
              const link = document.createElement("a");
              link.download = "meu-time.svg";
              link.href = dataUrl;
              link.click();
              alert("PNG falhou, baixando como SVG. Abra em um editor de imagens para converter.");

              // Remove a classe após o fallback
              document.querySelectorAll(".no-capture-item").forEach(el => {
                el.classList.remove("no-capture");
              });
            })
            .catch(function (svgError) {
              console.error("Erro ao gerar SVG:", svgError);
              alert("Erro ao baixar a imagem. Tente recarregar a página ou use um navegador diferente.");

              // Remove a classe em caso de erro
              document.querySelectorAll(".no-capture-item").forEach(el => {
                el.classList.remove("no-capture");
              });
            });
        } else {
          alert("Biblioteca de fallback não carregou. Tente recarregar a página.");

          // Remove a classe em caso de erro
          document.querySelectorAll(".no-capture-item").forEach(el => {
            el.classList.remove("no-capture");
          });
        }
      });
    }
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
</body>
</html>
